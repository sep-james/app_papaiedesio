<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat - Ecoltarema</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    background: #e8f5e9;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background: #2e7d32;
    color: white;
    padding: 15px;
    font-size: 1.3rem;
    font-weight: bold;
    text-align: center;
  }
  #chatContainer {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #f5f5f5;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .msg {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 1rem;
    line-height: 1.3;
    word-wrap: break-word;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    position: relative;
  }
  .msg.remetente {
    background: #2e7d32;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 0;
  }
  .msg.destinatario {
    background: #c8e6c9;
    color: #333;
    align-self: flex-start;
    border-bottom-left-radius: 0;
  }
  #inputContainer {
    display: flex;
    padding: 10px;
    background: white;
    border-top: 1px solid #ccc;
  }
  #inputMsg {
    flex: 1;
    padding: 10px 15px;
    border: 1px solid #ccc;
    border-radius: 25px;
    font-size: 1rem;
    outline: none;
    transition: border-color 0.3s ease;
  }
  #inputMsg:focus {
    border-color: #2e7d32;
    box-shadow: 0 0 5px rgba(46,125,50,0.3);
  }
  #btnEnviar {
    background: #2e7d32;
    color: white;
    border: none;
    margin-left: 10px;
    padding: 0 20px;
    border-radius: 25px;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #btnEnviar:hover {
    background-color: #1b4d23;
  }
  #btnVoltar {
    background: #555;
    color: white;
    border: none;
    padding: 10px 15px;
    font-weight: bold;
    cursor: pointer;
    border-radius: 8px;
    margin: 10px;
  }
  #btnVoltar:hover {
    background: #333;
  }
  #msgAviso {
    text-align: center;
    color: #a00;
    margin-top: 10px;
    display: none;
  }
</style>
</head>
<body>

<header>Chat - Ecoltarema</header>

<div id="chatContainer"></div>

<div id="inputContainer">
  <input type="text" id="inputMsg" placeholder="Digite sua mensagem..." autocomplete="off" />
  <button id="btnEnviar">Enviar</button>
</div>

<p id="msgAviso">O chat ficará disponível apenas após a coleta ser aceita.</p>

<button id="btnVoltar" onclick="window.location.href='menu.html'">⬅ Voltar ao Menu</button>

<script>
  // Identificação do usuário (doador ou coletor)
  const tipoUsuario = localStorage.getItem('tipoUsuario') || 'doador'; 
  // Verifica se a coleta foi aceita
  const coletaAceita = localStorage.getItem('coletaAceita') === 'true';

  const chatContainer = document.getElementById('chatContainer');
  const inputMsg = document.getElementById('inputMsg');
  const btnEnviar = document.getElementById('btnEnviar');
  const msgAviso = document.getElementById('msgAviso');
  const inputContainer = document.getElementById('inputContainer');

  // Recupera mensagens do localStorage
  let mensagens = JSON.parse(localStorage.getItem('chatMensagens')) || [];

  // Renderiza as mensagens na tela
  function renderizarMensagens() {
    chatContainer.innerHTML = '';
    mensagens.forEach(msg => {
      const divMsg = document.createElement('div');
      divMsg.classList.add('msg');
      divMsg.classList.add(msg.remetente === tipoUsuario ? 'remetente' : 'destinatario');
      divMsg.textContent = msg.texto;
      chatContainer.appendChild(divMsg);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  // Função para enviar mensagem (só se coleta estiver aceita)
  function enviarMensagem() {
    if (!coletaAceita) return; // bloqueia envio

    const texto = inputMsg.value.trim();
    if (!texto) return;

    mensagens.push({
      remetente: tipoUsuario,
      texto: texto,
      data: new Date().toISOString()
    });

    localStorage.setItem('chatMensagens', JSON.stringify(mensagens));
    inputMsg.value = '';
    renderizarMensagens();
  }

  btnEnviar.addEventListener('click', enviarMensagem);
  inputMsg.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      enviarMensagem();
    }
  });

  // Inicializa chat e configura UI de acordo com status da coleta
  if (coletaAceita) {
    renderizarMensagens();
    inputMsg.disabled = false;
    btnEnviar.disabled = false;
    msgAviso.style.display = 'none';
  } else {
    chatContainer.innerHTML = '<p style="text-align:center; color:#a00;">Chat indisponível até a coleta ser aceita.</p>';
    inputMsg.disabled = true;
    btnEnviar.disabled = true;
    msgAviso.style.display = 'block';
  }
</script>

</body>
</html>